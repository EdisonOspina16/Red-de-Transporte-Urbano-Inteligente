<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultado - Sistema de Transporte Urbano Inteligente</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='/estilos.css') }}" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style type="text/css">
        #network {
            width: 100%;
            height: 500px;
            border: 1px solid lightgray;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>Resultado de la Ruta</h1>
            <p class="subtitle">Sistema de Transporte Urbano Inteligente</p>
        </header>

        <div class="dashboard">
            <div class="info-panel">
                <div class="route-summary">
                    <h3><i class="fas fa-info-circle"></i> Resumen del Viaje</h3>
                    <div class="summary-item">
                        <i class="fas fa-clock"></i>
                        <span>Hora estimada de llegada: {{ hora_llegada }}</span>
                    </div>
                </div>
            </div>

            <div class="route-details">
                <div class="result-card">
                    <div class="route-header">
                        <div class="station-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <span class="label">Origen</span>
                                <span class="value">{{ origen }}</span>
                            </div>
                        </div>
                        <div class="travel-time">
                            <i class="fas fa-clock"></i>
                            <span>{{ tiempo }} minutos</span>
                        </div>
                        <div class="station-info">
                            <i class="fas fa-flag-checkered"></i>
                            <div>
                                <span class="label">Destino</span>
                                <span class="value">{{ destino }}</span>
                            </div>
                        </div>
                    </div>

                    {% if camino %}
                    <div class="route-path">
                        <div class="route-header-buttons">
                            <h3><i class="fas fa-route"></i> Ruta Detallada</h3>
                            <div class="route-buttons">
                                <button class="route-btn active" onclick="mostrarRuta('principal')">
                                    <i class="fas fa-route"></i> Ruta Principal
                                </button>
                                <button class="route-btn" onclick="mostrarRuta('alternativa1')">
                                    <i class="fas fa-random"></i> Ruta Alternativa 1
                                </button>
                            </div>
                        </div>
                        <div class="path-steps" id="ruta-principal">
                            {% for i in range(camino|length) %}
                            <div class="path-step">
                                <div class="step-marker" style="background-color: #3498db;"></div>
                                <div class="step-content">
                                    <span class="station-name">{{ camino[i] }}</span>
                                    {% if i == 0 %}
                                        <span class="transport-type"><i class="fas fa-play"></i> Inicio del recorrido</span>
                                    {% elif i == camino|length - 1 %}
                                        <span class="transport-type"><i class="fas fa-flag-checkered"></i> Destino final</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if not loop.last %}
                            <div class="path-connector" style="background-color: #3498db;"></div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Contenedores para rutas alternativas -->
                    <div class="path-steps" id="ruta-alternativa1" style="display: none;">
                        {% if rutas_alternativas and rutas_alternativas|length > 0 %}
                            <div class="route-time-info">
                                <i class="fas fa-clock"></i>
                                <span>Tiempo estimado: {{ tiempos_alternativos[0] }} minutos</span>
                                <span>(Llegada: {{ horas_llegada_alt[0] }})</span>
                            </div>
                            {% for i in range(rutas_alternativas[0]|length) %}
                            <div class="path-step">
                                <div class="step-marker" style="background-color: #2ecc71;"></div>
                                <div class="step-content">
                                    <span class="station-name">{{ rutas_alternativas[0][i] }}</span>
                                    {% if i == 0 %}
                                        <span class="transport-type"><i class="fas fa-play"></i> Inicio del recorrido</span>
                                    {% elif i == rutas_alternativas[0]|length - 1 %}
                                        <span class="transport-type"><i class="fas fa-flag-checkered"></i> Destino final</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if not loop.last %}
                            <div class="path-connector" style="background-color: #2ecc71;"></div>
                            {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="no-route-message">
                                <i class="fas fa-info-circle"></i>
                                <p>No hay ruta alternativa disponible en este momento.</p>
                            </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>No se encontró una ruta entre las estaciones seleccionadas.</p>
                    </div>
                    {% endif %}
                </div>

                <div class="action-buttons">
                    <a href="/" class="back-button">
                        <i class="fas fa-arrow-left"></i> Volver al inicio
                    </a>
                </div>
            </div>

            <div class="status-panel">
                <h3><i class="fas fa-chart-line"></i> Estado de la Ruta</h3>
                <div class="status-indicators">
                    <div class="status-item">
                        <i class="fas fa-traffic-light"></i>
                        <span class="status-label">Congestión</span>
                        <span class="status-value {{ clase_congestion }}">{{ estado_congestion }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="transport-legend">
                <h3><i class="fas fa-map-signs"></i> Medios de Transporte</h3>
                <div class="legend-item" data-type="metro">
                    <div class="legend-icon">
                        <i class="fas fa-subway"></i>
                        <span class="legend-color" style="background-color: #3498db;"></span>
                    </div>
                    <div class="legend-info">
                        <h4>Metro</h4>
                        <p>Líneas M1 y M2</p>
                        <ul>
                            <li>M1: Centro Histórico - Universidad - Intercambiador Central</li>
                            <li>M2: Plaza Mayor - Intercambiador Central - Deportivo</li>
                        </ul>
                    </div>
                </div>
                <div class="legend-item" data-type="bus">
                    <div class="legend-icon">
                        <i class="fas fa-bus"></i>
                        <span class="legend-color" style="background-color: #2ecc71;"></span>
                    </div>
                    <div class="legend-info">
                        <h4>Bus</h4>
                        <p>Líneas B1 y B2</p>
                        <ul>
                            <li>B1: Mercado Central - Biblioteca</li>
                            <li>B2: Parque Industrial - Centro Comercial</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="network"></div>
        </div>

        <script type="text/javascript">
            // Datos de la red
            var nodes = new vis.DataSet([
                {% for estacion in todas_estaciones %}
                {
                    id: "{{ estacion.id }}",
                    label: "{{ estacion.nombre }}",
                    title: "{{ estacion.nombre }} ({{ estacion.tipo }})",
                    shape: 'icon',
                    icon: {
                        face: '"Font Awesome 6 Free"',
                        code: {% if estacion.tipo == "metro" %}'"\uf239"'
                        {% elif estacion.tipo == "bus" %}'"\uf207"'
                        {% else %}'"\uf542"'{% endif %},
                        size: 40,
                        color: {% if estacion.tipo == "metro" %}"#3498db"
                        {% elif estacion.tipo == "bus" %}"#2ecc71"
                        {% else %}"#95a5a6"{% endif %}
                    },
                    font: {
                        size: 16,
                        face: 'Roboto',
                        color: {% if estacion.id in camino_ids %}"#000000"{% else %}"#666666"{% endif %},
                        bold: {% if estacion.id in camino_ids %}true{% else %}false{% endif %},
                        background: 'rgba(255, 255, 255, 0.9)',
                        strokeWidth: 4,
                        strokeColor: 'white'
                    },
                    size: {% if estacion.id in camino_ids %}35{% else %}30{% endif %},
                    borderWidth: {% if estacion.id in camino_ids %}3{% else %}1{% endif %},
                    borderWidthSelected: 3,
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            values.shadow = true;
                            if (hovering) {
                                values.size += 5;
                            }
                        }
                    }
                },
                {% endfor %}
            ]);

            var edges = new vis.DataSet([
                {% for ruta in todas_rutas %}
                {
                    from: "{{ ruta.origen }}",
                    to: "{{ ruta.destino }}",
                    arrows: "to",
                    color: {
                        color: {% if (ruta.origen, ruta.destino) in rutas_camino %}"#f1c40f"
                        {% elif ruta.tipo == "metro" %}"#3498db"
                        {% elif ruta.tipo == "bus" %}"#2ecc71"
                        {% elif ruta.tipo == "tren" %}"#e74c3c"
                        {% else %}"#95a5a6"{% endif %},
                        highlight: "#f1c40f",
                        width: {% if (ruta.origen, ruta.destino) in rutas_camino %}3{% else %}1{% endif %}
                    },
                    width: {% if (ruta.origen, ruta.destino) in rutas_camino %}3{% else %}1{% endif %},
                    label: "{{ ruta.tiempo }}min"
                },
                {% endfor %}
            ]);

            // Crear la red
            var container = document.getElementById('network');
            var data = {
                nodes: nodes,
                edges: edges
            };
            var options = {
                nodes: {
                    shape: 'icon',
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 10,
                        x: 5,
                        y: 5
                    },
                    chosen: true
                },
                edges: {
                    width: 2,
                    color: {
                        inherit: false,
                        opacity: 0.8
                    },
                    smooth: {
                        type: 'continuous',
                        roundness: 0.5
                    },
                    font: {
                        size: 14,
                        face: 'Roboto',
                        background: 'white',
                        strokeWidth: 0,
                        align: 'horizontal'
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 0.7
                        }
                    }
                },
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -500,
                        centralGravity: 0.01,
                        springLength: 200,
                        springConstant: 0.08,
                        damping: 0.4,
                        avoidOverlap: 1
                    },
                    stabilization: {
                        enabled: true,
                        iterations: 1000,
                        updateInterval: 25
                    }
                },
                layout: {
                    randomSeed: 2,
                    improvedLayout: true
                },
                interaction: {
                    hover: true,
                    navigationButtons: true,
                    keyboard: true,
                    zoomView: true,
                    dragView: true
                }
            };
            var network = new vis.Network(container, data, options);

            // Posicionar los nodos en forma de mapa de metro
            network.on("stabilizationIterationsDone", function () {
                var nodePositions = {
                    // Línea M1 (horizontal superior)
                    'M1_CentroHistorico': { x: -300, y: -200 },
                    'M1_ParqueCentral': { x: -100, y: -200 },
                    'M1_Universidad': { x: 100, y: -200 },
                    'M1_Intercambiador': { x: 200, y: -200 },
                    
                    // Línea M2 (vertical derecha)
                    'M2_PlazaMayor': { x: 200, y: -100 },
                    'M2_Intercambiador': { x: 200, y: -200 },
                    'M2_HospitalGeneral': { x: 200, y: 100 },
                    'M2_Deportivo': { x: 200, y: 200 },
                    
                    // Buses B1 (izquierda)
                    'B1_MercadoCentral': { x: -400, y: -100 },
                    'B1_Biblioteca': { x: -400, y: 0 },
                    
                    // Buses B2 (derecha)
                    'B2_ParqueIndustrial': { x: 400, y: -100 },
                    'B2_CentroComercial': { x: 400, y: 100 }
                };

                network.setOptions({ physics: false });
                Object.keys(nodePositions).forEach(function(nodeId) {
                    network.moveNode(nodeId, nodePositions[nodeId].x, nodePositions[nodeId].y);
                });
            });

            // Ajustar el zoom para mostrar todos los nodos
            network.once("afterDrawing", function() {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            });
        </script>

        <div class="route-legend">
            <h3>Leyenda:</h3>
            <ul>
                <li><span class="legend-color" style="background-color: #3498db;"></span> Metro</li>
                <li><span class="legend-color" style="background-color: #2ecc71;"></span> Bus</li>
                <li><span class="legend-color" style="background-color: #f1c40f;"></span> Ruta actual</li>
            </ul>
        </div>

        <footer class="main-footer">
            <p>Sistema actualizado en tiempo real | <i class="fas fa-clock"></i> Última actualización: {{ current_time }}</p>
        </footer>
    </div>

    <script>
        function mostrarRuta(tipo) {
            // Ocultar todas las rutas
            document.getElementById('ruta-principal').style.display = 'none';
            document.getElementById('ruta-alternativa1').style.display = 'none';
            
            // Mostrar la ruta seleccionada
            document.getElementById('ruta-' + tipo).style.display = 'block';
            
            // Actualizar botones activos
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="mostrarRuta('${tipo}')"]`).classList.add('active');
        }
    </script>
</body>
</html>
